name: Convert issues to comments

on:
  issues:
    types: [opened]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create comment file
        run: |
          mkdir -p comments
          BODY="${{ github.event.issue.body }}"
          
          # Extract fields
          name=$(echo "$BODY" | grep "^name:" | cut -d':' -f2- | xargs)
          slug=$(echo "$BODY" | grep "^slug:" | cut -d':' -f2- | xargs)
          comment=$(echo "$BODY" | sed -n '/^comment:/,/^slug:/p' | sed '1d;$d')
          
          mkdir -p "comments/$slug"
          file="comments/$slug/$(date +%s).yml"
          
          {
            echo "name: \"$name\""
            echo "date: \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\""
            echo "comment: |"
            echo "$comment" | sed 's/^/  /'
          } > "$file"

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add comments
          git commit -m "Add comment for $slug"
          git push

      - name: Close the issue
        uses: peter-evans/close-issue@v2
