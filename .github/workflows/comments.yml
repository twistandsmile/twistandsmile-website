name: Convert issues to JSON comment PRs

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  add-comment:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout full history so branches/PRs work properly
      - name: Checkout full repo history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false   # we'll use BOT_PAT instead

      # 2. Create JSON comment and save it as a JS file from issue body
      # -- We make a JS file because JSON files are not served by GitHub Pages
      - name: Create/append to comments-data.js
        id: makefile
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          set +e   # prevent abort on minor parsing errors

          BODY="$ISSUE_BODY"

          # Extract fields
          name=$(echo "$BODY" | awk -F': ' '/^name:/{print $2}')
          slug=$(echo "$BODY" | awk -F': ' '/^slug:/{print $2}')
          comment=$(echo "$BODY" \
            | sed -n '/^comment:/,/^slug:/p' \
            | sed '1d;$d')

          [ -z "$slug" ] && slug="general"
          [ -z "$name" ] && name="Anonymous"

          filename="js/comments-data.js"

          # Replace all double quotes with single quotes
          esc_name=${name//\"/\'}
          esc_slug=${slug//\"/\'}
          esc_comment=${comment//\"/\'}
          esc_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Build JSON object
          new_obj=$(printf '{ "slug": "%s", "name": "%s", "date": "%s", "comment": "%s" }' \
            "$esc_slug" "$esc_name" "$esc_date" "$esc_comment")

          # Insert the new object before the last closing bracket ']'
          # Detect if array is empty
          if grep -q '"comments": \[\s*]' "$filename"; then
            # No comma needed – empty list
            sed -i "s/]/  $new_obj ]/" "$filename"
          else
            # Non-empty – add comma
            sed -i "s/]/,  $new_obj ]/" "$filename"
          fi

          echo "filename=$filename" >> $GITHUB_OUTPUT
          echo "slug=$slug" >> $GITHUB_OUTPUT

      # 3. Debug: make sure file exists where we think it does
      - name: Debug repo state
        run: |
          echo "=== Repo files after creating comment file ==="
          ls -R .

      # 4. Configure git identity
      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 5. Create new branch and commit the comment file, then push with BOT_PAT
      - name: Create and push branch
        id: newbranch
        env:
          BOT_PAT: ${{ secrets.BOT_PAT }}
        run: |
          branch="comment-${{ github.event.issue.number }}"
          echo "branch=$branch" >> $GITHUB_OUTPUT

          # Use BOT_PAT for pushing
          git remote set-url origin "https://x-access-token:${BOT_PAT}@github.com/${{ github.repository }}.git"

          git checkout -b "$branch"

          if [ ! -f "${{ steps.makefile.outputs.filename }}" ]; then
            echo "ERROR: Comment file not found: ${% raw %}{{% endraw %} steps.makefile.outputs.filename }}"
            ls -R .
            exit 1
          fi

          git add "${{ steps.makefile.outputs.filename }}"

          if git diff --cached --quiet; then
            echo "ERROR: No changes to commit — cannot create PR."
            exit 1
          fi

          git commit -m "Add comment file from issue #${{ github.event.issue.number }}"
          git push --set-upstream origin "$branch"

      # 6. Install GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y git gh

      # 7. Authenticate gh CLI with BOT_PAT (not GITHUB_TOKEN)
      - name: Authenticate gh CLI
        env:
          BOT_PAT: ${{ secrets.BOT_PAT }}
        run: |
          echo "$BOT_PAT" | gh auth login --with-token

      # 8. Create the Pull Request
      - name: Create Pull Request
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          SLUG: ${{ steps.makefile.outputs.slug }}
          BRANCH: ${{ steps.newbranch.outputs.branch }}
        run: |
          gh pr create \
            --title "Comment from issue #$ISSUE_NUMBER" \
            --body "This PR adds a comment for article **$SLUG**." \
            --base main \
            --head "$BRANCH"

      # 9. Close the original issue
      - name: Close the issue
        uses: peter-evans/close-issue@v2
